{% extends 'base.html' %}
{% load static %}
{% load tags %}
{% load render_bundle from webpack_loader %}

{% block title %}Event{% endblock title %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/payments.css' %}">
    <link rel="stylesheet" href="{% static 'css/auth.css' %}">
    <link rel="stylesheet" href="{% static 'css/events.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css"/>
{% endblock %}

{% block content %}
    <main>
        <span 
            class='config'

            data-csrf-token='{{ csrf_token }}'

            data-event-id='{{event.event_id}}'

            data-resend-verification='{{ api.resend_verification }}'
            data-remove-verification='{{ api.remove_verification }}'
            data-recent-verification='{{ api.recent_verification }}'

            data-add-payment='{{ api.add_payment }}'
            data-get-payments='{{ api.get_payments }}'
            data-remove-payment='{{ api.remove_payment }}',

            data-get-payment-methods='{% cross_app_reverse_tag "accounts" "get_payments" %}'
            data-add-payment-method='{% cross_app_reverse_tag "accounts" "add_payment" %}'
            data-remove-payment-method='{% cross_app_reverse_tag "accounts" "remove_payment" %}'
            data-create-payment-intent='{% cross_app_reverse_tag "accounts" "create_payment" %}'
            data-check-payment-intent='{% cross_app_reverse_tag "accounts" "check_payment" %}'
            
            data-create-payment='{{ api.create_payment }}'
            data-check-payment='{{ api.check_payment }}'

            data-get-reviews='{{ api.get_reviews }}'
            data-update-review='{{ api.update_review }}'
            data-delete-review='{{ api.delete_review }}'

            data-stripe-pub='{{ stripe_key }}'
        ></span>

        <div class="nav-gap container">

            <!-- Main Details -->
            <div class="row text-light">

                <div class="col-md-3 col-sm-12 mx-auto p-2 third-page">

                    <!-- Update Event Button -->
                    {% if can_edit %}
                    <a href="update/" class="text-muted">Edit Event</a>
                    {% endif %}

                    <!-- Category -->
                    <div class="mx-2 my-4">
                        {% for category in event.categories.all %}
                        <span class="badge bg-primary">{{category.name}}</span>
                        {% endfor %}
                    </div>

                    <!-- Event Poster -->
                    <div class="d-flex flex-row mx-2 my-4">
                        <!-- If No Media, Use Default Event Cover Image -->
                        {% if event.get_media_count == 0 %}
                        <img class="event-cover" src="{% static 'images/default_event_cover.png' %}" alt="No Event Cover Photo">
                        {% else %}
                        <!-- Media Carousel -->
                            <div class="swiper mySwiper">
                                <div class="swiper-wrapper">
                                    {% for media in event.get_media %}
                                    <div class="swiper-slide">
                                        <img src="{{ media.picture.url }}" alt="Event Media Photo">
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="swiper-pagination"></div>
                                <div class="s-btn swiper-button-prev"></div>
                                <div class="s-btn swiper-button-next"></div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- Streamer Name -->
                    <div class="mx-2 my-4">
                        <h4><b>Streamer</b></h4>
                        <a href="">
                            <p>@{{ event.broadcaster.handle }}</p>
                        </a>
                    </div>
                    <!-- Overall Event Rating -->
                    <div class="mx-2 my-4">
                        <h4 class="w-100"><b>Event Rating</b></h4>         
                            <span class="fa fa-star {% if event.get_average_rating > 0 %} checked {% endif %}"></span>
                            <span class="fa fa-star {% if event.get_average_rating > 1 %} checked {% endif %}"></span>
                            <span class="fa fa-star {% if event.get_average_rating > 2 %} checked {% endif %}"></span>
                            <span class="fa fa-star {% if event.get_average_rating > 3 %} checked {% endif %}"></span>
                            <span class="fa fa-star {% if event.get_average_rating > 4 %} checked {% endif %}"></span>
                    </div>
                </div>

                <div class="col-md-6 col-sm-12 mx-auto p-2 half-page">
                    <!-- 
                        Event Title 
                    -->
                    <div class="mx-2 my-4">
                        <h2 class="page-title">{{ event.title }}</h2>
                    </div>


                    <hr>


                    <!-- 
                        Event Description 
                        -->
                    <div class="mx-2 my-4">
                        <p>{{ event.description | slice:':380' }}. . .</p>
                    </div>


                    <hr>


                    <!-- 
                        Tickets 
                    -->
                    <div class="mx-2 my-4">
                        <h4><b>Tickets</b></h4>
                        <div>
                            {% if event.has_ticket_listings > 0 %}
                                {% for ticket in event.get_ticket_listings %}
                                    <div class="
                                        row 
                                        m-1
                                        bk-theme-backdrop
                                        p-2
                                        rounded
                                    ">
                                        <div class="
                                            d-flex 
                                            justify-content-between 
                                            w-100
                                            mb-2
                                            fs-5
                                        ">
                                            <div class="m-0">{{ ticket.ticket_detail }}</div>
                                            <div class='text-muted m-0'>€{{ ticket.price }}</div>
                                        </div>

                                        <div class='btn-group w-100 d-flex justify-content-between slim-btn'>
                                            {% comment %} <button 
                                                class="w-25 h-100 btn btn-primary info loader-btn"
                                                id='dec-{{ ticket.listing_id }}'
                                                loader-state='default'>   
                                                <span> <div class='spinner-border' role='status'> 
                                                <span class='visually-hidden'>Loading...</span> </div> </span>
                                                <p><i class="fas fa-minus"></i></p>
                                            </button> {% endcomment %}

                                            <button 
                                                name="purchase-stream" 
                                                data-ticket-id="{{ ticket.listing_id }}" 
                                                data-item-name="{{ ticket.ticket_detail }}" 
                                                data-item-price="€{{ ticket.price }}"
                                                type="submit" 
                                                class="
                                                    btn
                                                    btn-success
                                                    success
                                                    loader-btn
                                                    w-100
                                                    slim-btn
                                                "
                                                loader-state='default'
                                            >   
                                                <span>
                                                    <div class='spinner-border' role='status'>
                                                        <span class='visually-hidden'>Loading...</span>
                                                    </div>
                                                </span>
                                                <p>Buy now</p>
                                            </button>

                                            {% comment %} <button 
                                                class="w-25 h-100 btn btn-primary info loader-btn slim-btn"
                                                id='inc-{{ ticket.listing_id }}'
                                                loader-state='default'>   
                                                <span> <div class='spinner-border' role='status'> 
                                                <span class='visually-hidden'>Loading...</span> </div> </span>
                                                <p><i class="fas fa-plus"></i></p>
                                            </button> {% endcomment %}
                                        </div>

                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <!--
                        Tickets END
                    -->


                </div>
                <!-- Showings -->
                <div class="col-md-3 col-sm-12 mx-auto third-page">
                    <div class="mx-2 my-4">
                        <h4><b>Showings</b></h4>
                    </div>
                    {% for showing in event.get_showings %}
                    <div class="mx-2 my-4">
                        <p class="m-0">{{showing.time }}</p>
                        <p class="m-0">
                            {% if showing.venue and showing.city %}
                            {{ showing.venue }} - {{ showing.city }}
                            {% elif showing.city %}
                            {{ showing.city }}
                            {% endif %}
                        </p>
                        <p>{{showing.country.name}}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Media for Event -->
            <div class="row">
                <!-- Event Reviews -->
                <div class="col-12">
                    <div class="mx-2 my-4">
                        <h4 ><b>Reviews</b></h4>
                    </div>
                    <!-- Review Carousel -->
                    <div class="swiper longSwiper">
                        <div class="swiper-wrapper">
                        <!-- Allow users to add review -->
                            {% if user.is_authenticated %}
                            <div class="swiper-slide">
                                {% include 'reviews/review_new.html' %}
                            </div>
                            {% endif %}
                            <!-- If more reviews, display in carousel -->
                            {% if event.get_review_count > 0 %}
                            {% for review in event.get_medium_reviews %}
                            <div class="swiper-slide">
                                {% include 'reviews/review.html' %}
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        <div class="swiper-pagination"></div>
                        <div class="s-btn swiper-button-prev"></div>
                        <div class="s-btn swiper-button-next"></div>
                    </div>
                </div>
            </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
<script src="/static/js/events.js"></script>
{% render_bundle 'events' %}
{% endblock content %}